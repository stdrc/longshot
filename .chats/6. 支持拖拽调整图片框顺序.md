# 支持拖拽调整图片框顺序
_Exported on 2025/8/17 at GMT+8 19:28:31 from Cursor (1.4.5)_

---

**User**

给选择图片框支持拖拽调整顺序。注意动效要越简单越好，但视觉反馈要非常明确。最好用库（用最小最轻量的库），不要无脑用原生，很可能实现不好。

---

**Cursor**

我需要先了解现有的图片选择框架构，然后为其添加拖拽排序功能。让我先检查一下当前的代码结构。

现在我了解了代码结构。我需要为图片选择框添加拖拽排序功能。我会选择使用 SortableJS，这是一个轻量且强大的拖拽排序库。让我创建任务列表并开始实现。

```html
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>长截图拼接工具</title>
  <!-- 引入 Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <!-- 引入 SortableJS 用于拖拽排序 -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      color: #2c3e50;
      line-height: 1.6;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 2.5em;
      font-weight: 300;
      color: #34495e;
      margin-bottom: 10px;
    }

    .header p {
      color: #7f8c8d;
      font-size: 1.1em;
    }

    .upload-section {
      background: white;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid #ddd;
      cursor: default;
      min-height: 160px;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }

    .upload-section h3 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-weight: 500;
    }

    .upload-section:hover {
      border-color: #3498db;
    }

    .upload-section.dragover {
      border-color: #2980b9;
    }

    .upload-prompt {
      padding: 0;
      display: flex;
      justify-content: flex-start;
    }

    .selected-images {
      width: 100%;
      text-align: left;
      margin: 0;
      padding: 0;
    }



    .add-more-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 120px;
      height: 120px;
      background: #f8f9fa;
      border: 2px dashed #3498db;
      border-radius: 8px;
      color: #3498db;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 2em;
      margin: 0;
    }

    .add-more-btn:hover {
      background: #e3f2fd;
      border-color: #2980b9;
      color: #2980b9;
    }

    .add-more-in-list {
      background: #f8f9fa !important;
      border: 2px dashed #3498db !important;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .add-more-in-list:hover {
      background: #e3f2fd !important;
      border-color: #2980b9 !important;
    }

    .add-more-icon {
      font-size: 2em;
      color: #3498db;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }





    .file-input {
      display: none;
    }

    .settings {
      background: white;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid #ddd;
    }

    .settings h3 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-weight: 500;
    }

    .setting-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .setting-item label {
      color: #34495e;
      font-weight: 500;
    }

    .setting-item input {
      width: 80px;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 2px;
      font-size: 14px;
    }

    .file-list {
      background: white;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid #ddd;
    }

    .file-list h3 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-weight: 500;
    }

    #fileItems {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 0;
      padding: 0;
    }

    .file-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      padding: 8px;
      cursor: default;
      position: relative;
      width: 120px;
      height: 120px;
    }

    .file-item:hover {
      border-color: #bdc3c7;
    }



    .file-icon {
      width: 100px;
      height: 100px;
      background: #3498db;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 12px;
      overflow: hidden;
      position: relative;
    }

    .file-preview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 6px;
    }

    .file-index {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      font-size: 12px;
      font-weight: bold;
      padding: 4px 6px;
      border-radius: 12px;
      line-height: 1;
      min-width: 20px;
      text-align: center;
    }



    .remove-btn {
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      padding: 6px;
      border-radius: 50%;
      cursor: pointer;
      position: absolute;
      top: 6px;
      right: 6px;
      z-index: 3;
      opacity: 0;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      backdrop-filter: blur(4px);
    }

    .file-item:hover .remove-btn {
      opacity: 1;
    }

    .remove-btn:hover {
      background: rgba(239, 68, 68, 0.9);
      transform: scale(1.1);
    }

    .remove-btn svg {
      width: 12px;
      height: 12px;
    }

    .actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 30px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 2px;
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #2980b9;
    }

    .btn-secondary {
      background: #95a5a6;
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #7f8c8d;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .progress {
      background: white;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 30px;
      display: none;
      border: 1px solid #ddd;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #ecf0f1;
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .progress-fill {
      height: 100%;
      background: #3498db;
      width: 0%;
    }

    .progress-text {
      text-align: center;
      color: #7f8c8d;
      font-size: 0.9em;
    }

    .result {
      background: white;
      border-radius: 4px;
      padding: 20px;
      text-align: center;
      display: none;
      border: 1px solid #ddd;
    }

    .result-image {
      max-width: 100%;
      max-height: 600px;
      border-radius: 2px;
      border: 1px solid #ddd;
      margin-bottom: 20px;
      cursor: pointer;
    }

    .image-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      cursor: pointer;
    }

    .image-modal img {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 95%;
      max-height: 95%;
      border-radius: 2px;
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 30px;
      color: white;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1001;
    }

    .empty-state {
      text-align: center;
      color: #7f8c8d;
      font-style: italic;
      padding: 20px 0;
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }

      .header h1 {
        font-size: 2em;
      }

      .upload-section {
        padding: 15px;
      }

      .actions {
        flex-direction: column;
      }

      .btn {
        justify-content: center;
      }

      #fileItems {
        gap: 10px;
        justify-content: flex-start;
      }

      .file-item {
        width: 100px;
        height: 100px;
        padding: 6px;
      }

      .file-icon {
        width: 85px;
        height: 85px;
      }

      .add-more-btn {
        width: 100px;
        height: 100px;
      }

      .remove-btn {
        width: 20px;
        height: 20px;
        padding: 4px;
        top: 4px;
        right: 4px;
      }

      .remove-btn svg {
        width: 10px;
        height: 10px;
      }
    }

    @media (max-width: 480px) {
      #fileItems {
        gap: 8px;
        justify-content: flex-start;
      }

      .file-item {
        width: 85px;
        height: 85px;
        padding: 4px;
      }

      .file-icon {
        width: 75px;
        height: 75px;
      }

      .add-more-btn {
        width: 85px;
        height: 85px;
      }

      .file-index {
        font-size: 10px;
        padding: 2px 4px;
      }
    }
  </style>
</head>

<body>
  <!-- SVG 图标定义 -->
  <svg style="display: none;">
    <defs>
      <symbol id="x-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
        stroke-linejoin="round">
        <path d="m18 6-12 12" />
        <path d="m6 6 12 12" />
      </symbol>
    </defs>
  </svg>

  <div class="container">
    <div class="header">
      <h1>长截图拼接工具</h1>
      <p>智能拼接多张截图，自动识别重叠区域</p>
    </div>

    <div class="upload-section" id="uploadArea">
      <h3>选择图片</h3>
      <div class="upload-prompt" id="uploadPrompt">
        <div class="add-more-btn" id="addMoreBtn">+</div>
      </div>
      <div class="selected-images" id="selectedImages" style="display: none;">
        <div id="fileItems"></div>
      </div>
      <input type="file" id="fileInput" class="file-input" multiple accept="image/*">
    </div>

    <div class="settings">
      <h3>设置</h3>
      <div class="setting-item">
        <label for="ignorePixels">忽略右侧像素数量:</label>
        <input type="number" id="ignorePixels" value="20" min="0" max="100">
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-primary" id="stitchBtn" disabled>
        开始拼接
      </button>
      <button class="btn btn-secondary" id="clearBtn" disabled>
        清空列表
      </button>
    </div>

    <div class="progress" id="progress">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">准备中...</div>
    </div>

    <div class="result" id="result">
      <h3>拼接结果</h3>
      <img id="resultImage" class="result-image" alt="拼接结果" title="点击查看大图">
      <div>
        <button class="btn btn-primary" id="downloadBtn">
          下载图片
        </button>
      </div>
    </div>

    <!-- 图片预览模态框 -->
    <div class="image-modal" id="imageModal">
      <span class="modal-close">&times;</span>
      <img id="modalImage" alt="预览图片">
    </div>
  </div>

  <script src="longshot.js"></script>
  <script>
    class LongShotApp {
      constructor() {
        this.stitcher = new LongScreenshotStitcher();
        this.selectedFiles = [];
        this.resultCanvas = null;



        this.initializeElements();
        this.bindEvents();
      }

      initializeElements() {
        this.uploadArea = document.getElementById('uploadArea');
        this.fileInput = document.getElementById('fileInput');
        this.uploadPrompt = document.getElementById('uploadPrompt');
        this.selectedImages = document.getElementById('selectedImages');
        this.fileItems = document.getElementById('fileItems');
        this.addMoreBtn = document.getElementById('addMoreBtn');
        this.stitchBtn = document.getElementById('stitchBtn');
        this.clearBtn = document.getElementById('clearBtn');
        this.progress = document.getElementById('progress');
        this.progressFill = document.getElementById('progressFill');
        this.progressText = document.getElementById('progressText');
        this.result = document.getElementById('result');
        this.resultImage = document.getElementById('resultImage');
        this.downloadBtn = document.getElementById('downloadBtn');
        this.ignorePixels = document.getElementById('ignorePixels');
        this.imageModal = document.getElementById('imageModal');
        this.modalImage = document.getElementById('modalImage');
      }

      bindEvents() {
        // 文件选择 - 只通过添加按钮触发
        this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));

        // 添加图片按钮
        this.addMoreBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.fileInput.click();
        });

        // 拖拽上传
        this.uploadArea.addEventListener('dragover', (e) => this.handleDragOver(e));
        this.uploadArea.addEventListener('dragleave', (e) => this.handleDragLeave(e));
        this.uploadArea.addEventListener('drop', (e) => this.handleDrop(e));

        // 按钮事件
        this.stitchBtn.addEventListener('click', () => this.startStitching());
        this.clearBtn.addEventListener('click', () => this.clearFiles());
        this.downloadBtn.addEventListener('click', () => this.downloadResult());

        // 设置变更
        this.ignorePixels.addEventListener('change', () => {
          this.stitcher.setIgnoreRightPixels(parseInt(this.ignorePixels.value) || 20);
        });

        // 图片预览模态框
        this.resultImage.addEventListener('click', () => this.showImageModal());
        this.imageModal.addEventListener('click', () => this.hideImageModal());
        document.querySelector('.modal-close').addEventListener('click', () => this.hideImageModal());
      }

      handleFileSelect(e) {
        const files = Array.from(e.target.files);
        this.addFiles(files);
      }

      handleDragOver(e) {
        e.preventDefault();
        this.uploadArea.classList.add('dragover');
      }

      handleDragLeave(e) {
        e.preventDefault();
        this.uploadArea.classList.remove('dragover');
      }

      handleDrop(e) {
        e.preventDefault();
        this.uploadArea.classList.remove('dragover');

        const files = Array.from(e.dataTransfer.files).filter(file =>
          file.type.startsWith('image/')
        );
        this.addFiles(files);
      }

      addFiles(files) {
        const validFiles = files.filter(file => file.type.startsWith('image/'));
        this.selectedFiles.push(...validFiles);
        this.updateFileList();
        this.updateButtons();
      }

      updateFileList() {
        if (this.selectedFiles.length === 0) {
          // 显示上传提示，隐藏图片区域
          this.uploadPrompt.style.display = 'flex';
          this.selectedImages.style.display = 'none';
          return;
        }

        // 隐藏上传提示，显示图片区域
        this.uploadPrompt.style.display = 'none';
        this.selectedImages.style.display = 'block';

        this.fileItems.innerHTML = '';
        this.selectedFiles.forEach((file, index) => {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';

          // 创建图片预览
          const fileIconContainer = document.createElement('div');
          fileIconContainer.className = 'file-icon';

          const filePreview = document.createElement('img');
          filePreview.className = 'file-preview';
          filePreview.alt = '图片预览';

          const fileIndex = document.createElement('div');
          fileIndex.className = 'file-index';
          fileIndex.textContent = index + 1;

          fileIconContainer.appendChild(filePreview);
          fileIconContainer.appendChild(fileIndex);

          // 添加删除按钮
          fileItem.innerHTML = `
                        <button class="remove-btn" onclick="app.removeFile(${index})">
                          <svg><use href="#x-icon"></use></svg>
                        </button>
                    `;

          // 将预览图片容器添加到文件项中
          fileItem.appendChild(fileIconContainer);

          // 生成图片预览
          this.generateImagePreview(file, filePreview);

          this.fileItems.appendChild(fileItem);
        });

        // 在图片后面添加"添加更多"按钮
        const addMoreInList = document.createElement('div');
        addMoreInList.className = 'file-item add-more-in-list';
        addMoreInList.innerHTML = '<div class="add-more-icon">+</div>';
        addMoreInList.addEventListener('click', (e) => {
          e.stopPropagation();
          this.fileInput.click();
        });
        this.fileItems.appendChild(addMoreInList);
      }

      generateImagePreview(file, imgElement) {
        const reader = new FileReader();
        reader.onload = function (e) {
          imgElement.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }

      removeFile(index) {
        this.selectedFiles.splice(index, 1);
        this.updateFileList();
        this.updateButtons();
      }







      clearFiles() {
        this.selectedFiles = [];
        this.fileInput.value = '';
        this.updateFileList();
        this.updateButtons();
        this.hideResult();
      }

      updateButtons() {
        const hasEnoughFiles = this.selectedFiles.length >= 2;
        this.stitchBtn.disabled = !hasEnoughFiles;
        this.clearBtn.disabled = this.selectedFiles.length === 0;
      }

      async startStitching() {
        if (this.selectedFiles.length < 2) {
          alert('请至少选择2张图片');
          return;
        }

        this.showProgress();
        this.hideResult();
        this.stitchBtn.disabled = true;

        try {
          this.resultCanvas = await this.stitcher.stitchMultipleImages(
            this.selectedFiles,
            (progress) => this.updateProgress(progress)
          );

          this.showResult();
        } catch (error) {
          console.error('拼接失败:', error);
          alert(`拼接失败: ${error.message}`);
        } finally {
          this.hideProgress();
          this.stitchBtn.disabled = false;
        }
      }

      updateProgress(progress) {
        let percentage, text;

        if (progress.stage === 'loading') {
          percentage = (progress.current / progress.total) * 50;
          text = `加载图片中... (${progress.current}/${progress.total})`;
        } else if (progress.stage === 'stitching') {
          percentage = 50 + (progress.current / progress.total) * 50;
          text = `拼接中... (${progress.current}/${progress.total})`;
        }

        this.progressFill.style.width = `${percentage}%`;
        this.progressText.textContent = text;
      }

      showProgress() {
        this.progress.style.display = 'block';
        this.progressFill.style.width = '0%';
        this.progressText.textContent = '准备中...';
      }

      hideProgress() {
        this.progress.style.display = 'none';
      }

      showResult() {
        if (this.resultCanvas) {
          this.resultImage.src = this.resultCanvas.toDataURL('image/jpeg', 0.9);
          this.result.style.display = 'block';

          // 滚动到结果区域
          this.result.scrollIntoView({ behavior: 'smooth' });
        }
      }

      hideResult() {
        this.result.style.display = 'none';
      }

      downloadResult() {
        if (!this.resultCanvas) return;

        const link = document.createElement('a');
        link.download = `longshot-result-${new Date().getTime()}.jpg`;
        link.href = this.resultCanvas.toDataURL('image/jpeg', 0.9);
        link.click();
      }

      showImageModal() {
        if (this.resultCanvas) {
          this.modalImage.src = this.resultCanvas.toDataURL('image/jpeg', 0.9);
          this.imageModal.style.display = 'block';
          document.body.style.overflow = 'hidden'; // 防止背景滚动
        }
      }

      hideImageModal() {
        this.imageModal.style.display = 'none';
        document.body.style.overflow = 'auto'; // 恢复背景滚动
      }

      formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
      }
    }

    // 初始化应用
    const app = new LongShotApp();

    // 初始化 Lucide 图标
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  </script>
</body>

</html>
```

```html
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>长截图拼接工具</title>
  <!-- 引入 Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <!-- 引入 SortableJS 用于拖拽排序 -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      color: #2c3e50;
      line-height: 1.6;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 2.5em;
      font-weight: 300;
      color: #34495e;
      margin-bottom: 10px;
    }

    .header p {
      color: #7f8c8d;
      font-size: 1.1em;
    }

    .upload-section {
      background: white;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid #ddd;
      cursor: default;
      min-height: 160px;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }

    .upload-section h3 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-weight: 500;
    }

    .upload-section:hover {
      border-color: #3498db;
    }

    .upload-section.dragover {
      border-color: #2980b9;
    }

    .upload-prompt {
      padding: 0;
      display: flex;
      justify-content: flex-start;
    }

    .selected-images {
      width: 100%;
      text-align: left;
      margin: 0;
      padding: 0;
    }



    .add-more-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 120px;
      height: 120px;
      background: #f8f9fa;
      border: 2px dashed #3498db;
      border-radius: 8px;
      color: #3498db;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 2em;
      margin: 0;
    }

    .add-more-btn:hover {
      background: #e3f2fd;
      border-color: #2980b9;
      color: #2980b9;
    }

    .add-more-in-list {
      background: #f8f9fa !important;
      border: 2px dashed #3498db !important;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .add-more-in-list:hover {
      background: #e3f2fd !important;
      border-color: #2980b9 !important;
    }

    .add-more-icon {
      font-size: 2em;
      color: #3498db;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }





    .file-input {
      display: none;
    }

    .settings {
      background: white;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid #ddd;
    }

    .settings h3 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-weight: 500;
    }

    .setting-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .setting-item label {
      color: #34495e;
      font-weight: 500;
    }

    .setting-item input {
      width: 80px;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 2px;
      font-size: 14px;
    }

    .file-list {
      background: white;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid #ddd;
    }

    .file-list h3 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-weight: 500;
    }

    #fileItems {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 0;
      padding: 0;
    }

    .file-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      padding: 8px;
      cursor: default;
      position: relative;
      width: 120px;
      height: 120px;
    }

    .file-item:hover {
      border-color: #bdc3c7;
    }

    /* 拖拽排序样式 */
    .file-item.sortable-chosen {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      border-color: #3498db;
      z-index: 10;
    }

    .file-item.sortable-ghost {
      opacity: 0.4;
      background: #f8f9fa;
      border: 2px dashed #3498db;
    }

    .sortable-drag {
      transform: rotate(5deg);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) !important;
    }

    /* 拖拽时隐藏删除按钮 */
    .file-item.sortable-chosen .remove-btn {
      opacity: 0 !important;
    }



    .file-icon {
      width: 100px;
      height: 100px;
      background: #3498db;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 12px;
      overflow: hidden;
      position: relative;
    }

    .file-preview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 6px;
    }

    .file-index {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      font-size: 12px;
      font-weight: bold;
      padding: 4px 6px;
      border-radius: 12px;
      line-height: 1;
      min-width: 20px;
      text-align: center;
    }



    .remove-btn {
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      padding: 6px;
      border-radius: 50%;
      cursor: pointer;
      position: absolute;
      top: 6px;
      right: 6px;
      z-index: 3;
      opacity: 0;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      backdrop-filter: blur(4px);
    }

    .file-item:hover .remove-btn {
      opacity: 1;
    }

    .remove-btn:hover {
      background: rgba(239, 68, 68, 0.9);
      transform: scale(1.1);
    }

    .remove-btn svg {
      width: 12px;
      height: 12px;
    }

    .actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 30px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 2px;
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #2980b9;
    }

    .btn-secondary {
      background: #95a5a6;
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #7f8c8d;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .progress {
      background: white;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 30px;
      display: none;
      border: 1px solid #ddd;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #ecf0f1;
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .progress-fill {
      height: 100%;
      background: #3498db;
      width: 0%;
    }

    .progress-text {
      text-align: center;
      color: #7f8c8d;
      font-size: 0.9em;
    }

    .result {
      background: white;
      border-radius: 4px;
      padding: 20px;
      text-align: center;
      display: none;
      border: 1px solid #ddd;
    }

    .result-image {
      max-width: 100%;
      max-height: 600px;
      border-radius: 2px;
      border: 1px solid #ddd;
      margin-bottom: 20px;
      cursor: pointer;
    }

    .image-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      cursor: pointer;
    }

    .image-modal img {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 95%;
      max-height: 95%;
      border-radius: 2px;
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 30px;
      color: white;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1001;
    }

    .empty-state {
      text-align: center;
      color: #7f8c8d;
      font-style: italic;
      padding: 20px 0;
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }

      .header h1 {
        font-size: 2em;
      }

      .upload-section {
        padding: 15px;
      }

      .actions {
        flex-direction: column;
      }

      .btn {
        justify-content: center;
      }

      #fileItems {
        gap: 10px;
        justify-content: flex-start;
      }

      .file-item {
        width: 100px;
        height: 100px;
        padding: 6px;
      }

      .file-icon {
        width: 85px;
        height: 85px;
      }

      .add-more-btn {
        width: 100px;
        height: 100px;
      }

      .remove-btn {
        width: 20px;
        height: 20px;
        padding: 4px;
        top: 4px;
        right: 4px;
      }

      .remove-btn svg {
        width: 10px;
        height: 10px;
      }
    }

    @media (max-width: 480px) {
      #fileItems {
        gap: 8px;
        justify-content: flex-start;
      }

      .file-item {
        width: 85px;
        height: 85px;
        padding: 4px;
      }

      .file-icon {
        width: 75px;
        height: 75px;
      }

      .add-more-btn {
        width: 85px;
        height: 85px;
      }

      .file-index {
        font-size: 10px;
        padding: 2px 4px;
      }
    }
  </style>
</head>

<body>
  <!-- SVG 图标定义 -->
  <svg style="display: none;">
    <defs>
      <symbol id="x-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
        stroke-linejoin="round">
        <path d="m18 6-12 12" />
        <path d="m6 6 12 12" />
      </symbol>
    </defs>
  </svg>

  <div class="container">
    <div class="header">
      <h1>长截图拼接工具</h1>
      <p>智能拼接多张截图，自动识别重叠区域</p>
    </div>

    <div class="upload-section" id="uploadArea">
      <h3>选择图片</h3>
      <div class="upload-prompt" id="uploadPrompt">
        <div class="add-more-btn" id="addMoreBtn">+</div>
      </div>
      <div class="selected-images" id="selectedImages" style="display: none;">
        <div id="fileItems"></div>
      </div>
      <input type="file" id="fileInput" class="file-input" multiple accept="image/*">
    </div>

    <div class="settings">
      <h3>设置</h3>
      <div class="setting-item">
        <label for="ignorePixels">忽略右侧像素数量:</label>
        <input type="number" id="ignorePixels" value="20" min="0" max="100">
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-primary" id="stitchBtn" disabled>
        开始拼接
      </button>
      <button class="btn btn-secondary" id="clearBtn" disabled>
        清空列表
      </button>
    </div>

    <div class="progress" id="progress">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">准备中...</div>
    </div>

    <div class="result" id="result">
      <h3>拼接结果</h3>
      <img id="resultImage" class="result-image" alt="拼接结果" title="点击查看大图">
      <div>
        <button class="btn btn-primary" id="downloadBtn">
          下载图片
        </button>
      </div>
    </div>

    <!-- 图片预览模态框 -->
    <div class="image-modal" id="imageModal">
      <span class="modal-close">&times;</span>
      <img id="modalImage" alt="预览图片">
    </div>
  </div>

  <script src="longshot.js"></script>
  <script>
    class LongShotApp {
      constructor() {
        this.stitcher = new LongScreenshotStitcher();
        this.selectedFiles = [];
        this.resultCanvas = null;



        this.initializeElements();
        this.bindEvents();
      }

      initializeElements() {
        this.uploadArea = document.getElementById('uploadArea');
        this.fileInput = document.getElementById('fileInput');
        this.uploadPrompt = document.getElementById('uploadPrompt');
        this.selectedImages = document.getElementById('selectedImages');
        this.fileItems = document.getElementById('fileItems');
        this.addMoreBtn = document.getElementById('addMoreBtn');
        this.stitchBtn = document.getElementById('stitchBtn');
        this.clearBtn = document.getElementById('clearBtn');
        this.progress = document.getElementById('progress');
        this.progressFill = document.getElementById('progressFill');
        this.progressText = document.getElementById('progressText');
        this.result = document.getElementById('result');
        this.resultImage = document.getElementById('resultImage');
        this.downloadBtn = document.getElementById('downloadBtn');
        this.ignorePixels = document.getElementById('ignorePixels');
        this.imageModal = document.getElementById('imageModal');
        this.modalImage = document.getElementById('modalImage');
      }

      bindEvents() {
        // 文件选择 - 只通过添加按钮触发
        this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));

        // 添加图片按钮
        this.addMoreBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.fileInput.click();
        });

        // 拖拽上传
        this.uploadArea.addEventListener('dragover', (e) => this.handleDragOver(e));
        this.uploadArea.addEventListener('dragleave', (e) => this.handleDragLeave(e));
        this.uploadArea.addEventListener('drop', (e) => this.handleDrop(e));

        // 按钮事件
        this.stitchBtn.addEventListener('click', () => this.startStitching());
        this.clearBtn.addEventListener('click', () => this.clearFiles());
        this.downloadBtn.addEventListener('click', () => this.downloadResult());

        // 设置变更
        this.ignorePixels.addEventListener('change', () => {
          this.stitcher.setIgnoreRightPixels(parseInt(this.ignorePixels.value) || 20);
        });

        // 图片预览模态框
        this.resultImage.addEventListener('click', () => this.showImageModal());
        this.imageModal.addEventListener('click', () => this.hideImageModal());
        document.querySelector('.modal-close').addEventListener('click', () => this.hideImageModal());
      }

      handleFileSelect(e) {
        const files = Array.from(e.target.files);
        this.addFiles(files);
      }

      handleDragOver(e) {
        e.preventDefault();
        this.uploadArea.classList.add('dragover');
      }

      handleDragLeave(e) {
        e.preventDefault();
        this.uploadArea.classList.remove('dragover');
      }

      handleDrop(e) {
        e.preventDefault();
        this.uploadArea.classList.remove('dragover');

        const files = Array.from(e.dataTransfer.files).filter(file =>
          file.type.startsWith('image/')
        );
        this.addFiles(files);
      }

      addFiles(files) {
        const validFiles = files.filter(file => file.type.startsWith('image/'));
        this.selectedFiles.push(...validFiles);
        this.updateFileList();
        this.updateButtons();
      }

      updateFileList() {
        if (this.selectedFiles.length === 0) {
          // 显示上传提示，隐藏图片区域
          this.uploadPrompt.style.display = 'flex';
          this.selectedImages.style.display = 'none';
          return;
        }

        // 隐藏上传提示，显示图片区域
        this.uploadPrompt.style.display = 'none';
        this.selectedImages.style.display = 'block';

        this.fileItems.innerHTML = '';
        this.selectedFiles.forEach((file, index) => {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';

          // 创建图片预览
          const fileIconContainer = document.createElement('div');
          fileIconContainer.className = 'file-icon';

          const filePreview = document.createElement('img');
          filePreview.className = 'file-preview';
          filePreview.alt = '图片预览';

          const fileIndex = document.createElement('div');
          fileIndex.className = 'file-index';
          fileIndex.textContent = index + 1;

          fileIconContainer.appendChild(filePreview);
          fileIconContainer.appendChild(fileIndex);

          // 添加删除按钮
          fileItem.innerHTML = `
                        <button class="remove-btn" onclick="app.removeFile(${index})">
                          <svg><use href="#x-icon"></use></svg>
                        </button>
                    `;

          // 将预览图片容器添加到文件项中
          fileItem.appendChild(fileIconContainer);

          // 生成图片预览
          this.generateImagePreview(file, filePreview);

          this.fileItems.appendChild(fileItem);
        });

        // 在图片后面添加"添加更多"按钮
        const addMoreInList = document.createElement('div');
        addMoreInList.className = 'file-item add-more-in-list';
        addMoreInList.innerHTML = '<div class="add-more-icon">+</div>';
        addMoreInList.addEventListener('click', (e) => {
          e.stopPropagation();
          this.fileInput.click();
        });
        this.fileItems.appendChild(addMoreInList);
      }

      generateImagePreview(file, imgElement) {
        const reader = new FileReader();
        reader.onload = function (e) {
          imgElement.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }

      removeFile(index) {
        this.selectedFiles.splice(index, 1);
        this.updateFileList();
        this.updateButtons();
      }







      clearFiles() {
        this.selectedFiles = [];
        this.fileInput.value = '';
        this.updateFileList();
        this.updateButtons();
        this.hideResult();
      }

      updateButtons() {
        const hasEnoughFiles = this.selectedFiles.length >= 2;
        this.stitchBtn.disabled = !hasEnoughFiles;
        this.clearBtn.disabled = this.selectedFiles.length === 0;
      }

      async startStitching() {
        if (this.selectedFiles.length < 2) {
          alert('请至少选择2张图片');
          return;
        }

        this.showProgress();
        this.hideResult();
        this.stitchBtn.disabled = true;

        try {
          this.resultCanvas = await this.stitcher.stitchMultipleImages(
            this.selectedFiles,
            (progress) => this.updateProgress(progress)
          );

          this.showResult();
        } catch (error) {
          console.error('拼接失败:', error);
          alert(`拼接失败: ${error.message}`);
        } finally {
          this.hideProgress();
          this.stitchBtn.disabled = false;
        }
      }

      updateProgress(progress) {
        let percentage, text;

        if (progress.stage === 'loading') {
          percentage = (progress.current / progress.total) * 50;
          text = `加载图片中... (${progress.current}/${progress.total})`;
        } else if (progress.stage === 'stitching') {
          percentage = 50 + (progress.current / progress.total) * 50;
          text = `拼接中... (${progress.current}/${progress.total})`;
        }

        this.progressFill.style.width = `${percentage}%`;
        this.progressText.textContent = text;
      }

      showProgress() {
        this.progress.style.display = 'block';
        this.progressFill.style.width = '0%';
        this.progressText.textContent = '准备中...';
      }

      hideProgress() {
        this.progress.style.display = 'none';
      }

      showResult() {
        if (this.resultCanvas) {
          this.resultImage.src = this.resultCanvas.toDataURL('image/jpeg', 0.9);
          this.result.style.display = 'block';

          // 滚动到结果区域
          this.result.scrollIntoView({ behavior: 'smooth' });
        }
      }

      hideResult() {
        this.result.style.display = 'none';
      }

      downloadResult() {
        if (!this.resultCanvas) return;

        const link = document.createElement('a');
        link.download = `longshot-result-${new Date().getTime()}.jpg`;
        link.href = this.resultCanvas.toDataURL('image/jpeg', 0.9);
        link.click();
      }

      showImageModal() {
        if (this.resultCanvas) {
          this.modalImage.src = this.resultCanvas.toDataURL('image/jpeg', 0.9);
          this.imageModal.style.display = 'block';
          document.body.style.overflow = 'hidden'; // 防止背景滚动
        }
      }

      hideImageModal() {
        this.imageModal.style.display = 'none';
        document.body.style.overflow = 'auto'; // 恢复背景滚动
      }

      formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
      }
    }

    // 初始化应用
    const app = new LongShotApp();

    // 初始化 Lucide 图标
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  </script>
</body>

</html>
```

现在添加拖拽排序的JavaScript实现：

```html
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>长截图拼接工具</title>
  <!-- 引入 Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <!-- 引入 SortableJS 用于拖拽排序 -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      color: #2c3e50;
      line-height: 1.6;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 2.5em;
      font-weight: 300;
      color: #34495e;
      margin-bottom: 10px;
    }

    .header p {
      color: #7f8c8d;
      font-size: 1.1em;
    }

    .upload-section {
      background: white;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid #ddd;
      cursor: default;
      min-height: 160px;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }

    .upload-section h3 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-weight: 500;
    }

    .upload-section:hover {
      border-color: #3498db;
    }

    .upload-section.dragover {
      border-color: #2980b9;
    }

    .upload-prompt {
      padding: 0;
      display: flex;
      justify-content: flex-start;
    }

    .selected-images {
      width: 100%;
      text-align: left;
      margin: 0;
      padding: 0;
    }



    .add-more-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 120px;
      height: 120px;
      background: #f8f9fa;
      border: 2px dashed #3498db;
      border-radius: 8px;
      color: #3498db;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 2em;
      margin: 0;
    }

    .add-more-btn:hover {
      background: #e3f2fd;
      border-color: #2980b9;
      color: #2980b9;
    }

    .add-more-in-list {
      background: #f8f9fa !important;
      border: 2px dashed #3498db !important;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .add-more-in-list:hover {
      background: #e3f2fd !important;
      border-color: #2980b9 !important;
    }

    .add-more-icon {
      font-size: 2em;
      color: #3498db;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }





    .file-input {
      display: none;
    }

    .settings {
      background: white;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid #ddd;
    }

    .settings h3 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-weight: 500;
    }

    .setting-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .setting-item label {
      color: #34495e;
      font-weight: 500;
    }

    .setting-item input {
      width: 80px;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 2px;
      font-size: 14px;
    }

    .file-list {
      background: white;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid #ddd;
    }

    .file-list h3 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-weight: 500;
    }

    #fileItems {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 0;
      padding: 0;
    }

    .file-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      padding: 8px;
      cursor: default;
      position: relative;
      width: 120px;
      height: 120px;
    }

    .file-item:hover {
      border-color: #bdc3c7;
    }

    /* 拖拽排序样式 */
    .file-item.sortable-chosen {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      border-color: #3498db;
      z-index: 10;
    }

    .file-item.sortable-ghost {
      opacity: 0.4;
      background: #f8f9fa;
      border: 2px dashed #3498db;
    }

    .sortable-drag {
      transform: rotate(5deg);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) !important;
    }

    /* 拖拽时隐藏删除按钮 */
    .file-item.sortable-chosen .remove-btn {
      opacity: 0 !important;
    }



    .file-icon {
      width: 100px;
      height: 100px;
      background: #3498db;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 12px;
      overflow: hidden;
      position: relative;
    }

    .file-preview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 6px;
    }

    .file-index {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      font-size: 12px;
      font-weight: bold;
      padding: 4px 6px;
      border-radius: 12px;
      line-height: 1;
      min-width: 20px;
      text-align: center;
    }



    .remove-btn {
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      padding: 6px;
      border-radius: 50%;
      cursor: pointer;
      position: absolute;
      top: 6px;
      right: 6px;
      z-index: 3;
      opacity: 0;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      backdrop-filter: blur(4px);
    }

    .file-item:hover .remove-btn {
      opacity: 1;
    }

    .remove-btn:hover {
      background: rgba(239, 68, 68, 0.9);
      transform: scale(1.1);
    }

    .remove-btn svg {
      width: 12px;
      height: 12px;
    }

    .actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 30px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 2px;
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #2980b9;
    }

    .btn-secondary {
      background: #95a5a6;
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #7f8c8d;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .progress {
      background: white;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 30px;
      display: none;
      border: 1px solid #ddd;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #ecf0f1;
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .progress-fill {
      height: 100%;
      background: #3498db;
      width: 0%;
    }

    .progress-text {
      text-align: center;
      color: #7f8c8d;
      font-size: 0.9em;
    }

    .result {
      background: white;
      border-radius: 4px;
      padding: 20px;
      text-align: center;
      display: none;
      border: 1px solid #ddd;
    }

    .result-image {
      max-width: 100%;
      max-height: 600px;
      border-radius: 2px;
      border: 1px solid #ddd;
      margin-bottom: 20px;
      cursor: pointer;
    }

    .image-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      cursor: pointer;
    }

    .image-modal img {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 95%;
      max-height: 95%;
      border-radius: 2px;
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 30px;
      color: white;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1001;
    }

    .empty-state {
      text-align: center;
      color: #7f8c8d;
      font-style: italic;
      padding: 20px 0;
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }

      .header h1 {
        font-size: 2em;
      }

      .upload-section {
        padding: 15px;
      }

      .actions {
        flex-direction: column;
      }

      .btn {
        justify-content: center;
      }

      #fileItems {
        gap: 10px;
        justify-content: flex-start;
      }

      .file-item {
        width: 100px;
        height: 100px;
        padding: 6px;
      }

      .file-icon {
        width: 85px;
        height: 85px;
      }

      .add-more-btn {
        width: 100px;
        height: 100px;
      }

      .remove-btn {
        width: 20px;
        height: 20px;
        padding: 4px;
        top: 4px;
        right: 4px;
      }

      .remove-btn svg {
        width: 10px;
        height: 10px;
      }
    }

    @media (max-width: 480px) {
      #fileItems {
        gap: 8px;
        justify-content: flex-start;
      }

      .file-item {
        width: 85px;
        height: 85px;
        padding: 4px;
      }

      .file-icon {
        width: 75px;
        height: 75px;
      }

      .add-more-btn {
        width: 85px;
        height: 85px;
      }

      .file-index {
        font-size: 10px;
        padding: 2px 4px;
      }
    }
  </style>
</head>

<body>
  <!-- SVG 图标定义 -->
  <svg style="display: none;">
    <defs>
      <symbol id="x-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
        stroke-linejoin="round">
        <path d="m18 6-12 12" />
        <path d="m6 6 12 12" />
      </symbol>
    </defs>
  </svg>

  <div class="container">
    <div class="header">
      <h1>长截图拼接工具</h1>
      <p>智能拼接多张截图，自动识别重叠区域</p>
    </div>

    <div class="upload-section" id="uploadArea">
      <h3>选择图片</h3>
      <div class="upload-prompt" id="uploadPrompt">
        <div class="add-more-btn" id="addMoreBtn">+</div>
      </div>
      <div class="selected-images" id="selectedImages" style="display: none;">
        <div id="fileItems"></div>
      </div>
      <input type="file" id="fileInput" class="file-input" multiple accept="image/*">
    </div>

    <div class="settings">
      <h3>设置</h3>
      <div class="setting-item">
        <label for="ignorePixels">忽略右侧像素数量:</label>
        <input type="number" id="ignorePixels" value="20" min="0" max="100">
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-primary" id="stitchBtn" disabled>
        开始拼接
      </button>
      <button class="btn btn-secondary" id="clearBtn" disabled>
        清空列表
      </button>
    </div>

    <div class="progress" id="progress">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">准备中...</div>
    </div>

    <div class="result" id="result">
      <h3>拼接结果</h3>
      <img id="resultImage" class="result-image" alt="拼接结果" title="点击查看大图">
      <div>
        <button class="btn btn-primary" id="downloadBtn">
          下载图片
        </button>
      </div>
    </div>

    <!-- 图片预览模态框 -->
    <div class="image-modal" id="imageModal">
      <span class="modal-close">&times;</span>
      <img id="modalImage" alt="预览图片">
    </div>
  </div>

  <script src="longshot.js"></script>
  <script>
    class LongShotApp {
      constructor() {
        this.stitcher = new LongScreenshotStitcher();
        this.selectedFiles = [];
        this.resultCanvas = null;
        this.sortable = null; // SortableJS 实例

        this.initializeElements();
        this.bindEvents();
      }

      initializeElements() {
        this.uploadArea = document.getElementById('uploadArea');
        this.fileInput = document.getElementById('fileInput');
        this.uploadPrompt = document.getElementById('uploadPrompt');
        this.selectedImages = document.getElementById('selectedImages');
        this.fileItems = document.getElementById('fileItems');
        this.addMoreBtn = document.getElementById('addMoreBtn');
        this.stitchBtn = document.getElementById('stitchBtn');
        this.clearBtn = document.getElementById('clearBtn');
        this.progress = document.getElementById('progress');
        this.progressFill = document.getElementById('progressFill');
        this.progressText = document.getElementById('progressText');
        this.result = document.getElementById('result');
        this.resultImage = document.getElementById('resultImage');
        this.downloadBtn = document.getElementById('downloadBtn');
        this.ignorePixels = document.getElementById('ignorePixels');
        this.imageModal = document.getElementById('imageModal');
        this.modalImage = document.getElementById('modalImage');
      }

      bindEvents() {
        // 文件选择 - 只通过添加按钮触发
        this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));

        // 添加图片按钮
        this.addMoreBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.fileInput.click();
        });

        // 拖拽上传
        this.uploadArea.addEventListener('dragover', (e) => this.handleDragOver(e));
        this.uploadArea.addEventListener('dragleave', (e) => this.handleDragLeave(e));
        this.uploadArea.addEventListener('drop', (e) => this.handleDrop(e));

        // 按钮事件
        this.stitchBtn.addEventListener('click', () => this.startStitching());
        this.clearBtn.addEventListener('click', () => this.clearFiles());
        this.downloadBtn.addEventListener('click', () => this.downloadResult());

        // 设置变更
        this.ignorePixels.addEventListener('change', () => {
          this.stitcher.setIgnoreRightPixels(parseInt(this.ignorePixels.value) || 20);
        });

        // 图片预览模态框
        this.resultImage.addEventListener('click', () => this.showImageModal());
        this.imageModal.addEventListener('click', () => this.hideImageModal());
        document.querySelector('.modal-close').addEventListener('click', () => this.hideImageModal());
      }

      handleFileSelect(e) {
        const files = Array.from(e.target.files);
        this.addFiles(files);
      }

      handleDragOver(e) {
        e.preventDefault();
        this.uploadArea.classList.add('dragover');
      }

      handleDragLeave(e) {
        e.preventDefault();
        this.uploadArea.classList.remove('dragover');
      }

      handleDrop(e) {
        e.preventDefault();
        this.uploadArea.classList.remove('dragover');

        const files = Array.from(e.dataTransfer.files).filter(file =>
          file.type.startsWith('image/')
        );
        this.addFiles(files);
      }

      addFiles(files) {
        const validFiles = files.filter(file => file.type.startsWith('image/'));
        this.selectedFiles.push(...validFiles);
        this.updateFileList();
        this.updateButtons();
      }

      updateFileList() {
        if (this.selectedFiles.length === 0) {
          // 显示上传提示，隐藏图片区域
          this.uploadPrompt.style.display = 'flex';
          this.selectedImages.style.display = 'none';
          return;
        }

        // 隐藏上传提示，显示图片区域
        this.uploadPrompt.style.display = 'none';
        this.selectedImages.style.display = 'block';

        this.fileItems.innerHTML = '';
        this.selectedFiles.forEach((file, index) => {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';

          // 创建图片预览
          const fileIconContainer = document.createElement('div');
          fileIconContainer.className = 'file-icon';

          const filePreview = document.createElement('img');
          filePreview.className = 'file-preview';
          filePreview.alt = '图片预览';

          const fileIndex = document.createElement('div');
          fileIndex.className = 'file-index';
          fileIndex.textContent = index + 1;

          fileIconContainer.appendChild(filePreview);
          fileIconContainer.appendChild(fileIndex);

          // 添加删除按钮
          fileItem.innerHTML = `
                        <button class="remove-btn" onclick="app.removeFile(${index})">
                          <svg><use href="#x-icon"></use></svg>
                        </button>
                    `;

          // 将预览图片容器添加到文件项中
          fileItem.appendChild(fileIconContainer);

          // 生成图片预览
          this.generateImagePreview(file, filePreview);

          this.fileItems.appendChild(fileItem);
        });

        // 在图片后面添加"添加更多"按钮
        const addMoreInList = document.createElement('div');
        addMoreInList.className = 'file-item add-more-in-list';
        addMoreInList.innerHTML = '<div class="add-more-icon">+</div>';
        addMoreInList.addEventListener('click', (e) => {
          e.stopPropagation();
          this.fileInput.click();
        });
        this.fileItems.appendChild(addMoreInList);
      }

      generateImagePreview(file, imgElement) {
        const reader = new FileReader();
        reader.onload = function (e) {
          imgElement.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }

      removeFile(index) {
        this.selectedFiles.splice(index, 1);
        this.updateFileList();
        this.updateButtons();
      }







      clearFiles() {
        this.selectedFiles = [];
        this.fileInput.value = '';
        this.updateFileList();
        this.updateButtons();
        this.hideResult();
      }

      updateButtons() {
        const hasEnoughFiles = this.selectedFiles.length >= 2;
        this.stitchBtn.disabled = !hasEnoughFiles;
        this.clearBtn.disabled = this.selectedFiles.length === 0;
      }

      async startStitching() {
        if (this.selectedFiles.length < 2) {
          alert('请至少选择2张图片');
          return;
        }

        this.showProgress();
        this.hideResult();
        this.stitchBtn.disabled = true;

        try {
          this.resultCanvas = await this.stitcher.stitchMultipleImages(
            this.selectedFiles,
            (progress) => this.updateProgress(progress)
          );

          this.showResult();
        } catch (error) {
          console.error('拼接失败:', error);
          alert(`拼接失败: ${error.message}`);
        } finally {
          this.hideProgress();
          this.stitchBtn.disabled = false;
        }
      }

      updateProgress(progress) {
        let percentage, text;

        if (progress.stage === 'loading') {
          percentage = (progress.current / progress.total) * 50;
          text = `加载图片中... (${progress.current}/${progress.total})`;
        } else if (progress.stage === 'stitching') {
          percentage = 50 + (progress.current / progress.total) * 50;
          text = `拼接中... (${progress.current}/${progress.total})`;
        }

        this.progressFill.style.width = `${percentage}%`;
        this.progressText.textContent = text;
      }

      showProgress() {
        this.progress.style.display = 'block';
        this.progressFill.style.width = '0%';
        this.progressText.textContent = '准备中...';
      }

      hideProgress() {
        this.progress.style.display = 'none';
      }

      showResult() {
        if (this.resultCanvas) {
          this.resultImage.src = this.resultCanvas.toDataURL('image/jpeg', 0.9);
          this.result.style.display = 'block';

          // 滚动到结果区域
          this.result.scrollIntoView({ behavior: 'smooth' });
        }
      }

      hideResult() {
        this.result.style.display = 'none';
      }

      downloadResult() {
        if (!this.resultCanvas) return;

        const link = document.createElement('a');
        link.download = `longshot-result-${new Date().getTime()}.jpg`;
        link.href = this.resultCanvas.toDataURL('image/jpeg', 0.9);
        link.click();
      }

      showImageModal() {
        if (this.resultCanvas) {
          this.modalImage.src = this.resultCanvas.toDataURL('image/jpeg', 0.9);
          this.imageModal.style.display = 'block';
          document.body.style.overflow = 'hidden'; // 防止背景滚动
        }
      }

      hideImageModal() {
        this.imageModal.style.display = 'none';
        document.body.style.overflow = 'auto'; // 恢复背景滚动
      }

      formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
      }
    }

    // 初始化应用
    const app = new LongShotApp();

    // 初始化 Lucide 图标
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  </script>
</body>

</html>
```

```html
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>长截图拼接工具</title>
  <!-- 引入 Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <!-- 引入 SortableJS 用于拖拽排序 -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      color: #2c3e50;
      line-height: 1.6;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 2.5em;
      font-weight: 300;
      color: #34495e;
      margin-bottom: 10px;
    }

    .header p {
      color: #7f8c8d;
      font-size: 1.1em;
    }

    .upload-section {
      background: white;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid #ddd;
      cursor: default;
      min-height: 160px;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }

    .upload-section h3 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-weight: 500;
    }

    .upload-section:hover {
      border-color: #3498db;
    }

    .upload-section.dragover {
      border-color: #2980b9;
    }

    .upload-prompt {
      padding: 0;
      display: flex;
      justify-content: flex-start;
    }

    .selected-images {
      width: 100%;
      text-align: left;
      margin: 0;
      padding: 0;
    }



    .add-more-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 120px;
      height: 120px;
      background: #f8f9fa;
      border: 2px dashed #3498db;
      border-radius: 8px;
      color: #3498db;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 2em;
      margin: 0;
    }

    .add-more-btn:hover {
      background: #e3f2fd;
      border-color: #2980b9;
      color: #2980b9;
    }

    .add-more-in-list {
      background: #f8f9fa !important;
      border: 2px dashed #3498db !important;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .add-more-in-list:hover {
      background: #e3f2fd !important;
      border-color: #2980b9 !important;
    }

    .add-more-icon {
      font-size: 2em;
      color: #3498db;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }





    .file-input {
      display: none;
    }

    .settings {
      background: white;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid #ddd;
    }

    .settings h3 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-weight: 500;
    }

    .setting-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .setting-item label {
      color: #34495e;
      font-weight: 500;
    }

    .setting-item input {
      width: 80px;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 2px;
      font-size: 14px;
    }

    .file-list {
      background: white;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid #ddd;
    }

    .file-list h3 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-weight: 500;
    }

    #fileItems {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 0;
      padding: 0;
    }

    .file-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      padding: 8px;
      cursor: default;
      position: relative;
      width: 120px;
      height: 120px;
    }

    .file-item:hover {
      border-color: #bdc3c7;
    }

    /* 拖拽排序样式 */
    .file-item.sortable-chosen {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      border-color: #3498db;
      z-index: 10;
    }

    .file-item.sortable-ghost {
      opacity: 0.4;
      background: #f8f9fa;
      border: 2px dashed #3498db;
    }

    .sortable-drag {
      transform: rotate(5deg);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) !important;
    }

    /* 拖拽时隐藏删除按钮 */
    .file-item.sortable-chosen .remove-btn {
      opacity: 0 !important;
    }



    .file-icon {
      width: 100px;
      height: 100px;
      background: #3498db;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 12px;
      overflow: hidden;
      position: relative;
    }

    .file-preview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 6px;
    }

    .file-index {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      font-size: 12px;
      font-weight: bold;
      padding: 4px 6px;
      border-radius: 12px;
      line-height: 1;
      min-width: 20px;
      text-align: center;
    }



    .remove-btn {
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      padding: 6px;
      border-radius: 50%;
      cursor: pointer;
      position: absolute;
      top: 6px;
      right: 6px;
      z-index: 3;
      opacity: 0;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      backdrop-filter: blur(4px);
    }

    .file-item:hover .remove-btn {
      opacity: 1;
    }

    .remove-btn:hover {
      background: rgba(239, 68, 68, 0.9);
      transform: scale(1.1);
    }

    .remove-btn svg {
      width: 12px;
      height: 12px;
    }

    .actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 30px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 2px;
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #2980b9;
    }

    .btn-secondary {
      background: #95a5a6;
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #7f8c8d;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .progress {
      background: white;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 30px;
      display: none;
      border: 1px solid #ddd;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #ecf0f1;
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .progress-fill {
      height: 100%;
      background: #3498db;
      width: 0%;
    }

    .progress-text {
      text-align: center;
      color: #7f8c8d;
      font-size: 0.9em;
    }

    .result {
      background: white;
      border-radius: 4px;
      padding: 20px;
      text-align: center;
      display: none;
      border: 1px solid #ddd;
    }

    .result-image {
      max-width: 100%;
      max-height: 600px;
      border-radius: 2px;
      border: 1px solid #ddd;
      margin-bottom: 20px;
      cursor: pointer;
    }

    .image-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      cursor: pointer;
    }

    .image-modal img {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 95%;
      max-height: 95%;
      border-radius: 2px;
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 30px;
      color: white;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1001;
    }

    .empty-state {
      text-align: center;
      color: #7f8c8d;
      font-style: italic;
      padding: 20px 0;
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }

      .header h1 {
        font-size: 2em;
      }

      .upload-section {
        padding: 15px;
      }

      .actions {
        flex-direction: column;
      }

      .btn {
        justify-content: center;
      }

      #fileItems {
        gap: 10px;
        justify-content: flex-start;
      }

      .file-item {
        width: 100px;
        height: 100px;
        padding: 6px;
      }

      .file-icon {
        width: 85px;
        height: 85px;
      }

      .add-more-btn {
        width: 100px;
        height: 100px;
      }

      .remove-btn {
        width: 20px;
        height: 20px;
        padding: 4px;
        top: 4px;
        right: 4px;
      }

      .remove-btn svg {
        width: 10px;
        height: 10px;
      }
    }

    @media (max-width: 480px) {
      #fileItems {
        gap: 8px;
        justify-content: flex-start;
      }

      .file-item {
        width: 85px;
        height: 85px;
        padding: 4px;
      }

      .file-icon {
        width: 75px;
        height: 75px;
      }

      .add-more-btn {
        width: 85px;
        height: 85px;
      }

      .file-index {
        font-size: 10px;
        padding: 2px 4px;
      }
    }
  </style>
</head>

<body>
  <!-- SVG 图标定义 -->
  <svg style="display: none;">
    <defs>
      <symbol id="x-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
        stroke-linejoin="round">
        <path d="m18 6-12 12" />
        <path d="m6 6 12 12" />
      </symbol>
    </defs>
  </svg>

  <div class="container">
    <div class="header">
      <h1>长截图拼接工具</h1>
      <p>智能拼接多张截图，自动识别重叠区域</p>
    </div>

    <div class="upload-section" id="uploadArea">
      <h3>选择图片</h3>
      <div class="upload-prompt" id="uploadPrompt">
        <div class="add-more-btn" id="addMoreBtn">+</div>
      </div>
      <div class="selected-images" id="selectedImages" style="display: none;">
        <div id="fileItems"></div>
      </div>
      <input type="file" id="fileInput" class="file-input" multiple accept="image/*">
    </div>

    <div class="settings">
      <h3>设置</h3>
      <div class="setting-item">
        <label for="ignorePixels">忽略右侧像素数量:</label>
        <input type="number" id="ignorePixels" value="20" min="0" max="100">
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-primary" id="stitchBtn" disabled>
        开始拼接
      </button>
      <button class="btn btn-secondary" id="clearBtn" disabled>
        清空列表
      </button>
    </div>

    <div class="progress" id="progress">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">准备中...</div>
    </div>

    <div class="result" id="result">
      <h3>拼接结果</h3>
      <img id="resultImage" class="result-image" alt="拼接结果" title="点击查看大图">
      <div>
        <button class="btn btn-primary" id="downloadBtn">
          下载图片
        </button>
      </div>
    </div>

    <!-- 图片预览模态框 -->
    <div class="image-modal" id="imageModal">
      <span class="modal-close">&times;</span>
      <img id="modalImage" alt="预览图片">
    </div>
  </div>

  <script src="longshot.js"></script>
  <script>
    class LongShotApp {
      constructor() {
        this.stitcher = new LongScreenshotStitcher();
        this.selectedFiles = [];
        this.resultCanvas = null;
        this.sortable = null; // SortableJS 实例

        this.initializeElements();
        this.bindEvents();
      }

      initializeElements() {
        this.uploadArea = document.getElementById('uploadArea');
        this.fileInput = document.getElementById('fileInput');
        this.uploadPrompt = document.getElementById('uploadPrompt');
        this.selectedImages = document.getElementById('selectedImages');
        this.fileItems = document.getElementById('fileItems');
        this.addMoreBtn = document.getElementById('addMoreBtn');
        this.stitchBtn = document.getElementById('stitchBtn');
        this.clearBtn = document.getElementById('clearBtn');
        this.progress = document.getElementById('progress');
        this.progressFill = document.getElementById('progressFill');
        this.progressText = document.getElementById('progressText');
        this.result = document.getElementById('result');
        this.resultImage = document.getElementById('resultImage');
        this.downloadBtn = document.getElementById('downloadBtn');
        this.ignorePixels = document.getElementById('ignorePixels');
        this.imageModal = document.getElementById('imageModal');
        this.modalImage = document.getElementById('modalImage');
      }

      bindEvents() {
        // 文件选择 - 只通过添加按钮触发
        this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));

        // 添加图片按钮
        this.addMoreBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.fileInput.click();
        });

        // 拖拽上传
        this.uploadArea.addEventListener('dragover', (e) => this.handleDragOver(e));
        this.uploadArea.addEventListener('dragleave', (e) => this.handleDragLeave(e));
        this.uploadArea.addEventListener('drop', (e) => this.handleDrop(e));

        // 按钮事件
        this.stitchBtn.addEventListener('click', () => this.startStitching());
        this.clearBtn.addEventListener('click', () => this.clearFiles());
        this.downloadBtn.addEventListener('click', () => this.downloadResult());

        // 设置变更
        this.ignorePixels.addEventListener('change', () => {
          this.stitcher.setIgnoreRightPixels(parseInt(this.ignorePixels.value) || 20);
        });

        // 图片预览模态框
        this.resultImage.addEventListener('click', () => this.showImageModal());
        this.imageModal.addEventListener('click', () => this.hideImageModal());
        document.querySelector('.modal-close').addEventListener('click', () => this.hideImageModal());
      }

      handleFileSelect(e) {
        const files = Array.from(e.target.files);
        this.addFiles(files);
      }

      handleDragOver(e) {
        e.preventDefault();
        this.uploadArea.classList.add('dragover');
      }

      handleDragLeave(e) {
        e.preventDefault();
        this.uploadArea.classList.remove('dragover');
      }

      handleDrop(e) {
        e.preventDefault();
        this.uploadArea.classList.remove('dragover');

        const files = Array.from(e.dataTransfer.files).filter(file =>
          file.type.startsWith('image/')
        );
        this.addFiles(files);
      }

      addFiles(files) {
        const validFiles = files.filter(file => file.type.startsWith('image/'));
        this.selectedFiles.push(...validFiles);
        this.updateFileList();
        this.updateButtons();
      }

      updateFileList() {
        if (this.selectedFiles.length === 0) {
          // 显示上传提示，隐藏图片区域
          this.uploadPrompt.style.display = 'flex';
          this.selectedImages.style.display = 'none';
          this.destroySortable(); // 销毁拖拽实例
          return;
        }

        // 隐藏上传提示，显示图片区域
        this.uploadPrompt.style.display = 'none';
        this.selectedImages.style.display = 'block';

        this.fileItems.innerHTML = '';
        this.selectedFiles.forEach((file, index) => {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          fileItem.setAttribute('data-file-index', index); // 添加数据属性用于拖拽

          // 创建图片预览
          const fileIconContainer = document.createElement('div');
          fileIconContainer.className = 'file-icon';

          const filePreview = document.createElement('img');
          filePreview.className = 'file-preview';
          filePreview.alt = '图片预览';

          const fileIndex = document.createElement('div');
          fileIndex.className = 'file-index';
          fileIndex.textContent = index + 1;

          fileIconContainer.appendChild(filePreview);
          fileIconContainer.appendChild(fileIndex);

          // 添加删除按钮
          fileItem.innerHTML = `
                        <button class="remove-btn" onclick="app.removeFile(${index})">
                          <svg><use href="#x-icon"></use></svg>
                        </button>
                    `;

          // 将预览图片容器添加到文件项中
          fileItem.appendChild(fileIconContainer);

          // 生成图片预览
          this.generateImagePreview(file, filePreview);

          this.fileItems.appendChild(fileItem);
        });

        // 在图片后面添加"添加更多"按钮
        const addMoreInList = document.createElement('div');
        addMoreInList.className = 'file-item add-more-in-list';
        addMoreInList.innerHTML = '<div class="add-more-icon">+</div>';
        addMoreInList.addEventListener('click', (e) => {
          e.stopPropagation();
          this.fileInput.click();
        });
        this.fileItems.appendChild(addMoreInList);

        // 初始化或重新初始化拖拽排序
        this.initializeSortable();
      }

      generateImagePreview(file, imgElement) {
        const reader = new FileReader();
        reader.onload = function (e) {
          imgElement.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }

      removeFile(index) {
        this.selectedFiles.splice(index, 1);
        this.updateFileList();
        this.updateButtons();
      }







      clearFiles() {
        this.selectedFiles = [];
        this.fileInput.value = '';
        this.updateFileList();
        this.updateButtons();
        this.hideResult();
      }

      updateButtons() {
        const hasEnoughFiles = this.selectedFiles.length >= 2;
        this.stitchBtn.disabled = !hasEnoughFiles;
        this.clearBtn.disabled = this.selectedFiles.length === 0;
      }

      async startStitching() {
        if (this.selectedFiles.length < 2) {
          alert('请至少选择2张图片');
          return;
        }

        this.showProgress();
        this.hideResult();
        this.stitchBtn.disabled = true;

        try {
          this.resultCanvas = await this.stitcher.stitchMultipleImages(
            this.selectedFiles,
            (progress) => this.updateProgress(progress)
          );

          this.showResult();
        } catch (error) {
          console.error('拼接失败:', error);
          alert(`拼接失败: ${error.message}`);
        } finally {
          this.hideProgress();
          this.stitchBtn.disabled = false;
        }
      }

      updateProgress(progress) {
        let percentage, text;

        if (progress.stage === 'loading') {
          percentage = (progress.current / progress.total) * 50;
          text = `加载图片中... (${progress.current}/${progress.total})`;
        } else if (progress.stage === 'stitching') {
          percentage = 50 + (progress.current / progress.total) * 50;
          text = `拼接中... (${progress.current}/${progress.total})`;
        }

        this.progressFill.style.width = `${percentage}%`;
        this.progressText.textContent = text;
      }

      showProgress() {
        this.progress.style.display = 'block';
        this.progressFill.style.width = '0%';
        this.progressText.textContent = '准备中...';
      }

      hideProgress() {
        this.progress.style.display = 'none';
      }

      showResult() {
        if (this.resultCanvas) {
          this.resultImage.src = this.resultCanvas.toDataURL('image/jpeg', 0.9);
          this.result.style.display = 'block';

          // 滚动到结果区域
          this.result.scrollIntoView({ behavior: 'smooth' });
        }
      }

      hideResult() {
        this.result.style.display = 'none';
      }

      downloadResult() {
        if (!this.resultCanvas) return;

        const link = document.createElement('a');
        link.download = `longshot-result-${new Date().getTime()}.jpg`;
        link.href = this.resultCanvas.toDataURL('image/jpeg', 0.9);
        link.click();
      }

      showImageModal() {
        if (this.resultCanvas) {
          this.modalImage.src = this.resultCanvas.toDataURL('image/jpeg', 0.9);
          this.imageModal.style.display = 'block';
          document.body.style.overflow = 'hidden'; // 防止背景滚动
        }
      }

      hideImageModal() {
        this.imageModal.style.display = 'none';
        document.body.style.overflow = 'auto'; // 恢复背景滚动
      }

      formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
      }
    }

    // 初始化应用
    const app = new LongShotApp();

    // 初始化 Lucide 图标
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  </script>
</body>

</html>
```

现在添加拖拽排序的初始化和销毁方法：

```html
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>长截图拼接工具</title>
  <!-- 引入 Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <!-- 引入 SortableJS 用于拖拽排序 -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      color: #2c3e50;
      line-height: 1.6;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 2.5em;
      font-weight: 300;
      color: #34495e;
      margin-bottom: 10px;
    }

    .header p {
      color: #7f8c8d;
      font-size: 1.1em;
    }

    .upload-section {
      background: white;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid #ddd;
      cursor: default;
      min-height: 160px;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }

    .upload-section h3 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-weight: 500;
    }

    .upload-section:hover {
      border-color: #3498db;
    }

    .upload-section.dragover {
      border-color: #2980b9;
    }

    .upload-prompt {
      padding: 0;
      display: flex;
      justify-content: flex-start;
    }

    .selected-images {
      width: 100%;
      text-align: left;
      margin: 0;
      padding: 0;
    }



    .add-more-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 120px;
      height: 120px;
      background: #f8f9fa;
      border: 2px dashed #3498db;
      border-radius: 8px;
      color: #3498db;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 2em;
      margin: 0;
    }

    .add-more-btn:hover {
      background: #e3f2fd;
      border-color: #2980b9;
      color: #2980b9;
    }

    .add-more-in-list {
      background: #f8f9fa !important;
      border: 2px dashed #3498db !important;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .add-more-in-list:hover {
      background: #e3f2fd !important;
      border-color: #2980b9 !important;
    }

    .add-more-icon {
      font-size: 2em;
      color: #3498db;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }





    .file-input {
      display: none;
    }

    .settings {
      background: white;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid #ddd;
    }

    .settings h3 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-weight: 500;
    }

    .setting-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .setting-item label {
      color: #34495e;
      font-weight: 500;
    }

    .setting-item input {
      width: 80px;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 2px;
      font-size: 14px;
    }

    .file-list {
      background: white;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid #ddd;
    }

    .file-list h3 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-weight: 500;
    }

    #fileItems {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 0;
      padding: 0;
    }

    .file-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      padding: 8px;
      cursor: default;
      position: relative;
      width: 120px;
      height: 120px;
    }

    .file-item:hover {
      border-color: #bdc3c7;
    }

    /* 拖拽排序样式 */
    .file-item.sortable-chosen {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      border-color: #3498db;
      z-index: 10;
    }

    .file-item.sortable-ghost {
      opacity: 0.4;
      background: #f8f9fa;
      border: 2px dashed #3498db;
    }

    .sortable-drag {
      transform: rotate(5deg);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) !important;
    }

    /* 拖拽时隐藏删除按钮 */
    .file-item.sortable-chosen .remove-btn {
      opacity: 0 !important;
    }



    .file-icon {
      width: 100px;
      height: 100px;
      background: #3498db;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 12px;
      overflow: hidden;
      position: relative;
    }

    .file-preview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 6px;
    }

    .file-index {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      font-size: 12px;
      font-weight: bold;
      padding: 4px 6px;
      border-radius: 12px;
      line-height: 1;
      min-width: 20px;
      text-align: center;
    }



    .remove-btn {
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      padding: 6px;
      border-radius: 50%;
      cursor: pointer;
      position: absolute;
      top: 6px;
      right: 6px;
      z-index: 3;
      opacity: 0;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      backdrop-filter: blur(4px);
    }

    .file-item:hover .remove-btn {
      opacity: 1;
    }

    .remove-btn:hover {
      background: rgba(239, 68, 68, 0.9);
      transform: scale(1.1);
    }

    .remove-btn svg {
      width: 12px;
      height: 12px;
    }

    .actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 30px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 2px;
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #2980b9;
    }

    .btn-secondary {
      background: #95a5a6;
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #7f8c8d;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .progress {
      background: white;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 30px;
      display: none;
      border: 1px solid #ddd;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #ecf0f1;
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .progress-fill {
      height: 100%;
      background: #3498db;
      width: 0%;
    }

    .progress-text {
      text-align: center;
      color: #7f8c8d;
      font-size: 0.9em;
    }

    .result {
      background: white;
      border-radius: 4px;
      padding: 20px;
      text-align: center;
      display: none;
      border: 1px solid #ddd;
    }

    .result-image {
      max-width: 100%;
      max-height: 600px;
      border-radius: 2px;
      border: 1px solid #ddd;
      margin-bottom: 20px;
      cursor: pointer;
    }

    .image-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      cursor: pointer;
    }

    .image-modal img {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 95%;
      max-height: 95%;
      border-radius: 2px;
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 30px;
      color: white;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1001;
    }

    .empty-state {
      text-align: center;
      color: #7f8c8d;
      font-style: italic;
      padding: 20px 0;
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }

      .header h1 {
        font-size: 2em;
      }

      .upload-section {
        padding: 15px;
      }

      .actions {
        flex-direction: column;
      }

      .btn {
        justify-content: center;
      }

      #fileItems {
        gap: 10px;
        justify-content: flex-start;
      }

      .file-item {
        width: 100px;
        height: 100px;
        padding: 6px;
      }

      .file-icon {
        width: 85px;
        height: 85px;
      }

      .add-more-btn {
        width: 100px;
        height: 100px;
      }

      .remove-btn {
        width: 20px;
        height: 20px;
        padding: 4px;
        top: 4px;
        right: 4px;
      }

      .remove-btn svg {
        width: 10px;
        height: 10px;
      }
    }

    @media (max-width: 480px) {
      #fileItems {
        gap: 8px;
        justify-content: flex-start;
      }

      .file-item {
        width: 85px;
        height: 85px;
        padding: 4px;
      }

      .file-icon {
        width: 75px;
        height: 75px;
      }

      .add-more-btn {
        width: 85px;
        height: 85px;
      }

      .file-index {
        font-size: 10px;
        padding: 2px 4px;
      }
    }
  </style>
</head>

<body>
  <!-- SVG 图标定义 -->
  <svg style="display: none;">
    <defs>
      <symbol id="x-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
        stroke-linejoin="round">
        <path d="m18 6-12 12" />
        <path d="m6 6 12 12" />
      </symbol>
    </defs>
  </svg>

  <div class="container">
    <div class="header">
      <h1>长截图拼接工具</h1>
      <p>智能拼接多张截图，自动识别重叠区域</p>
    </div>

    <div class="upload-section" id="uploadArea">
      <h3>选择图片</h3>
      <div class="upload-prompt" id="uploadPrompt">
        <div class="add-more-btn" id="addMoreBtn">+</div>
      </div>
      <div class="selected-images" id="selectedImages" style="display: none;">
        <div id="fileItems"></div>
      </div>
      <input type="file" id="fileInput" class="file-input" multiple accept="image/*">
    </div>

    <div class="settings">
      <h3>设置</h3>
      <div class="setting-item">
        <label for="ignorePixels">忽略右侧像素数量:</label>
        <input type="number" id="ignorePixels" value="20" min="0" max="100">
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-primary" id="stitchBtn" disabled>
        开始拼接
      </button>
      <button class="btn btn-secondary" id="clearBtn" disabled>
        清空列表
      </button>
    </div>

    <div class="progress" id="progress">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">准备中...</div>
    </div>

    <div class="result" id="result">
      <h3>拼接结果</h3>
      <img id="resultImage" class="result-image" alt="拼接结果" title="点击查看大图">
      <div>
        <button class="btn btn-primary" id="downloadBtn">
          下载图片
        </button>
      </div>
    </div>

    <!-- 图片预览模态框 -->
    <div class="image-modal" id="imageModal">
      <span class="modal-close">&times;</span>
      <img id="modalImage" alt="预览图片">
    </div>
  </div>

  <script src="longshot.js"></script>
  <script>
    class LongShotApp {
      constructor() {
        this.stitcher = new LongScreenshotStitcher();
        this.selectedFiles = [];
        this.resultCanvas = null;
        this.sortable = null; // SortableJS 实例

        this.initializeElements();
        this.bindEvents();
      }

      initializeElements() {
        this.uploadArea = document.getElementById('uploadArea');
        this.fileInput = document.getElementById('fileInput');
        this.uploadPrompt = document.getElementById('uploadPrompt');
        this.selectedImages = document.getElementById('selectedImages');
        this.fileItems = document.getElementById('fileItems');
        this.addMoreBtn = document.getElementById('addMoreBtn');
        this.stitchBtn = document.getElementById('stitchBtn');
        this.clearBtn = document.getElementById('clearBtn');
        this.progress = document.getElementById('progress');
        this.progressFill = document.getElementById('progressFill');
        this.progressText = document.getElementById('progressText');
        this.result = document.getElementById('result');
        this.resultImage = document.getElementById('resultImage');
        this.downloadBtn = document.getElementById('downloadBtn');
        this.ignorePixels = document.getElementById('ignorePixels');
        this.imageModal = document.getElementById('imageModal');
        this.modalImage = document.getElementById('modalImage');
      }

      bindEvents() {
        // 文件选择 - 只通过添加按钮触发
        this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));

        // 添加图片按钮
        this.addMoreBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.fileInput.click();
        });

        // 拖拽上传
        this.uploadArea.addEventListener('dragover', (e) => this.handleDragOver(e));
        this.uploadArea.addEventListener('dragleave', (e) => this.handleDragLeave(e));
        this.uploadArea.addEventListener('drop', (e) => this.handleDrop(e));

        // 按钮事件
        this.stitchBtn.addEventListener('click', () => this.startStitching());
        this.clearBtn.addEventListener('click', () => this.clearFiles());
        this.downloadBtn.addEventListener('click', () => this.downloadResult());

        // 设置变更
        this.ignorePixels.addEventListener('change', () => {
          this.stitcher.setIgnoreRightPixels(parseInt(this.ignorePixels.value) || 20);
        });

        // 图片预览模态框
        this.resultImage.addEventListener('click', () => this.showImageModal());
        this.imageModal.addEventListener('click', () => this.hideImageModal());
        document.querySelector('.modal-close').addEventListener('click', () => this.hideImageModal());
      }

      handleFileSelect(e) {
        const files = Array.from(e.target.files);
        this.addFiles(files);
      }

      handleDragOver(e) {
        e.preventDefault();
        this.uploadArea.classList.add('dragover');
      }

      handleDragLeave(e) {
        e.preventDefault();
        this.uploadArea.classList.remove('dragover');
      }

      handleDrop(e) {
        e.preventDefault();
        this.uploadArea.classList.remove('dragover');

        const files = Array.from(e.dataTransfer.files).filter(file =>
          file.type.startsWith('image/')
        );
        this.addFiles(files);
      }

      addFiles(files) {
        const validFiles = files.filter(file => file.type.startsWith('image/'));
        this.selectedFiles.push(...validFiles);
        this.updateFileList();
        this.updateButtons();
      }

      updateFileList() {
        if (this.selectedFiles.length === 0) {
          // 显示上传提示，隐藏图片区域
          this.uploadPrompt.style.display = 'flex';
          this.selectedImages.style.display = 'none';
          this.destroySortable(); // 销毁拖拽实例
          return;
        }

        // 隐藏上传提示，显示图片区域
        this.uploadPrompt.style.display = 'none';
        this.selectedImages.style.display = 'block';

        this.fileItems.innerHTML = '';
        this.selectedFiles.forEach((file, index) => {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          fileItem.setAttribute('data-file-index', index); // 添加数据属性用于拖拽

          // 创建图片预览
          const fileIconContainer = document.createElement('div');
          fileIconContainer.className = 'file-icon';

          const filePreview = document.createElement('img');
          filePreview.className = 'file-preview';
          filePreview.alt = '图片预览';

          const fileIndex = document.createElement('div');
          fileIndex.className = 'file-index';
          fileIndex.textContent = index + 1;

          fileIconContainer.appendChild(filePreview);
          fileIconContainer.appendChild(fileIndex);

          // 添加删除按钮
          fileItem.innerHTML = `
                        <button class="remove-btn" onclick="app.removeFile(${index})">
                          <svg><use href="#x-icon"></use></svg>
                        </button>
                    `;

          // 将预览图片容器添加到文件项中
          fileItem.appendChild(fileIconContainer);

          // 生成图片预览
          this.generateImagePreview(file, filePreview);

          this.fileItems.appendChild(fileItem);
        });

        // 在图片后面添加"添加更多"按钮
        const addMoreInList = document.createElement('div');
        addMoreInList.className = 'file-item add-more-in-list';
        addMoreInList.innerHTML = '<div class="add-more-icon">+</div>';
        addMoreInList.addEventListener('click', (e) => {
          e.stopPropagation();
          this.fileInput.click();
        });
        this.fileItems.appendChild(addMoreInList);

        // 初始化或重新初始化拖拽排序
        this.initializeSortable();
      }

      generateImagePreview(file, imgElement) {
        const reader = new FileReader();
        reader.onload = function (e) {
          imgElement.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }

      removeFile(index) {
        this.selectedFiles.splice(index, 1);
        this.updateFileList();
        this.updateButtons();
      }

      // 初始化拖拽排序功能
      initializeSortable() {
        this.destroySortable(); // 先销毁之前的实例

        if (this.selectedFiles.length <= 1) return; // 只有一张图片时不需要排序

        this.sortable = new Sortable(this.fileItems, {
          animation: 200, // 动画时长
          ghostClass: 'sortable-ghost', // 拖拽时的占位符样式
          chosenClass: 'sortable-chosen', // 被选中元素的样式
          dragClass: 'sortable-drag', // 拖拽中元素的样式
          filter: '.add-more-in-list', // 排除"添加更多"按钮
          preventOnFilter: false,
          forceFallback: false, // 使用原生 HTML5 拖拽
          fallbackTolerance: 3,
          
          onStart: (evt) => {
            // 拖拽开始时的处理
            console.log('开始拖拽图片', evt.oldIndex);
          },
          
          onEnd: (evt) => {
            // 拖拽结束后更新文件顺序
            if (evt.newIndex !== evt.oldIndex) {
              this.reorderFiles(evt.oldIndex, evt.newIndex);
            }
          }
        });
      }

      // 销毁拖拽排序实例
      destroySortable() {
        if (this.sortable) {
          this.sortable.destroy();
          this.sortable = null;
        }
      }

      // 重新排序文件数组
      reorderFiles(oldIndex, newIndex) {
        if (oldIndex === newIndex) return;

        // 移动文件到新位置
        const movedFile = this.selectedFiles.splice(oldIndex, 1)[0];
        this.selectedFiles.splice(newIndex, 0, movedFile);

        console.log(`图片从位置 ${oldIndex + 1} 移动到位置 ${newIndex + 1}`);

        // 重新渲染列表以更新序号
        this.updateFileList();
      }







      clearFiles() {
        this.selectedFiles = [];
        this.fileInput.value = '';
        this.updateFileList();
        this.updateButtons();
        this.hideResult();
      }

      updateButtons() {
        const hasEnoughFiles = this.selectedFiles.length >= 2;
        this.stitchBtn.disabled = !hasEnoughFiles;
        this.clearBtn.disabled = this.selectedFiles.length === 0;
      }

      async startStitching() {
        if (this.selectedFiles.length < 2) {
          alert('请至少选择2张图片');
          return;
        }

        this.showProgress();
        this.hideResult();
        this.stitchBtn.disabled = true;

        try {
          this.resultCanvas = await this.stitcher.stitchMultipleImages(
            this.selectedFiles,
            (progress) => this.updateProgress(progress)
          );

          this.showResult();
        } catch (error) {
          console.error('拼接失败:', error);
          alert(`拼接失败: ${error.message}`);
        } finally {
          this.hideProgress();
          this.stitchBtn.disabled = false;
        }
      }

      updateProgress(progress) {
        let percentage, text;

        if (progress.stage === 'loading') {
          percentage = (progress.current / progress.total) * 50;
          text = `加载图片中... (${progress.current}/${progress.total})`;
        } else if (progress.stage === 'stitching') {
          percentage = 50 + (progress.current / progress.total) * 50;
          text = `拼接中... (${progress.current}/${progress.total})`;
        }

        this.progressFill.style.width = `${percentage}%`;
        this.progressText.textContent = text;
      }

      showProgress() {
        this.progress.style.display = 'block';
        this.progressFill.style.width = '0%';
        this.progressText.textContent = '准备中...';
      }

      hideProgress() {
        this.progress.style.display = 'none';
      }

      showResult() {
        if (this.resultCanvas) {
          this.resultImage.src = this.resultCanvas.toDataURL('image/jpeg', 0.9);
          this.result.style.display = 'block';

          // 滚动到结果区域
          this.result.scrollIntoView({ behavior: 'smooth' });
        }
      }

      hideResult() {
        this.result.style.display = 'none';
      }

      downloadResult() {
        if (!this.resultCanvas) return;

        const link = document.createElement('a');
        link.download = `longshot-result-${new Date().getTime()}.jpg`;
        link.href = this.resultCanvas.toDataURL('image/jpeg', 0.9);
        link.click();
      }

      showImageModal() {
        if (this.resultCanvas) {
          this.modalImage.src = this.resultCanvas.toDataURL('image/jpeg', 0.9);
          this.imageModal.style.display = 'block';
          document.body.style.overflow = 'hidden'; // 防止背景滚动
        }
      }

      hideImageModal() {
        this.imageModal.style.display = 'none';
        document.body.style.overflow = 'auto'; // 恢复背景滚动
      }

      formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
      }
    }

    // 初始化应用
    const app = new LongShotApp();

    // 初始化 Lucide 图标
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  </script>
</body>

</html>
```

现在完成最后的任务，更新清空文件时也销毁拖拽实例：

```html
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>长截图拼接工具</title>
  <!-- 引入 Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <!-- 引入 SortableJS 用于拖拽排序 -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      color: #2c3e50;
      line-height: 1.6;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 2.5em;
      font-weight: 300;
      color: #34495e;
      margin-bottom: 10px;
    }

    .header p {
      color: #7f8c8d;
      font-size: 1.1em;
    }

    .upload-section {
      background: white;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid #ddd;
      cursor: default;
      min-height: 160px;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }

    .upload-section h3 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-weight: 500;
    }

    .upload-section:hover {
      border-color: #3498db;
    }

    .upload-section.dragover {
      border-color: #2980b9;
    }

    .upload-prompt {
      padding: 0;
      display: flex;
      justify-content: flex-start;
    }

    .selected-images {
      width: 100%;
      text-align: left;
      margin: 0;
      padding: 0;
    }



    .add-more-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 120px;
      height: 120px;
      background: #f8f9fa;
      border: 2px dashed #3498db;
      border-radius: 8px;
      color: #3498db;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 2em;
      margin: 0;
    }

    .add-more-btn:hover {
      background: #e3f2fd;
      border-color: #2980b9;
      color: #2980b9;
    }

    .add-more-in-list {
      background: #f8f9fa !important;
      border: 2px dashed #3498db !important;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .add-more-in-list:hover {
      background: #e3f2fd !important;
      border-color: #2980b9 !important;
    }

    .add-more-icon {
      font-size: 2em;
      color: #3498db;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }





    .file-input {
      display: none;
    }

    .settings {
      background: white;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid #ddd;
    }

    .settings h3 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-weight: 500;
    }

    .setting-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .setting-item label {
      color: #34495e;
      font-weight: 500;
    }

    .setting-item input {
      width: 80px;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 2px;
      font-size: 14px;
    }

    .file-list {
      background: white;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid #ddd;
    }

    .file-list h3 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-weight: 500;
    }

    #fileItems {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 0;
      padding: 0;
    }

    .file-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      padding: 8px;
      cursor: default;
      position: relative;
      width: 120px;
      height: 120px;
    }

    .file-item:hover {
      border-color: #bdc3c7;
    }

    /* 拖拽排序样式 */
    .file-item.sortable-chosen {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      border-color: #3498db;
      z-index: 10;
    }

    .file-item.sortable-ghost {
      opacity: 0.4;
      background: #f8f9fa;
      border: 2px dashed #3498db;
    }

    .sortable-drag {
      transform: rotate(5deg);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) !important;
    }

    /* 拖拽时隐藏删除按钮 */
    .file-item.sortable-chosen .remove-btn {
      opacity: 0 !important;
    }



    .file-icon {
      width: 100px;
      height: 100px;
      background: #3498db;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 12px;
      overflow: hidden;
      position: relative;
    }

    .file-preview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 6px;
    }

    .file-index {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      font-size: 12px;
      font-weight: bold;
      padding: 4px 6px;
      border-radius: 12px;
      line-height: 1;
      min-width: 20px;
      text-align: center;
    }



    .remove-btn {
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      padding: 6px;
      border-radius: 50%;
      cursor: pointer;
      position: absolute;
      top: 6px;
      right: 6px;
      z-index: 3;
      opacity: 0;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      backdrop-filter: blur(4px);
    }

    .file-item:hover .remove-btn {
      opacity: 1;
    }

    .remove-btn:hover {
      background: rgba(239, 68, 68, 0.9);
      transform: scale(1.1);
    }

    .remove-btn svg {
      width: 12px;
      height: 12px;
    }

    .actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 30px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 2px;
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #2980b9;
    }

    .btn-secondary {
      background: #95a5a6;
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #7f8c8d;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .progress {
      background: white;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 30px;
      display: none;
      border: 1px solid #ddd;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #ecf0f1;
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .progress-fill {
      height: 100%;
      background: #3498db;
      width: 0%;
    }

    .progress-text {
      text-align: center;
      color: #7f8c8d;
      font-size: 0.9em;
    }

    .result {
      background: white;
      border-radius: 4px;
      padding: 20px;
      text-align: center;
      display: none;
      border: 1px solid #ddd;
    }

    .result-image {
      max-width: 100%;
      max-height: 600px;
      border-radius: 2px;
      border: 1px solid #ddd;
      margin-bottom: 20px;
      cursor: pointer;
    }

    .image-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      cursor: pointer;
    }

    .image-modal img {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 95%;
      max-height: 95%;
      border-radius: 2px;
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 30px;
      color: white;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1001;
    }

    .empty-state {
      text-align: center;
      color: #7f8c8d;
      font-style: italic;
      padding: 20px 0;
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }

      .header h1 {
        font-size: 2em;
      }

      .upload-section {
        padding: 15px;
      }

      .actions {
        flex-direction: column;
      }

      .btn {
        justify-content: center;
      }

      #fileItems {
        gap: 10px;
        justify-content: flex-start;
      }

      .file-item {
        width: 100px;
        height: 100px;
        padding: 6px;
      }

      .file-icon {
        width: 85px;
        height: 85px;
      }

      .add-more-btn {
        width: 100px;
        height: 100px;
      }

      .remove-btn {
        width: 20px;
        height: 20px;
        padding: 4px;
        top: 4px;
        right: 4px;
      }

      .remove-btn svg {
        width: 10px;
        height: 10px;
      }
    }

    @media (max-width: 480px) {
      #fileItems {
        gap: 8px;
        justify-content: flex-start;
      }

      .file-item {
        width: 85px;
        height: 85px;
        padding: 4px;
      }

      .file-icon {
        width: 75px;
        height: 75px;
      }

      .add-more-btn {
        width: 85px;
        height: 85px;
      }

      .file-index {
        font-size: 10px;
        padding: 2px 4px;
      }
    }
  </style>
</head>

<body>
  <!-- SVG 图标定义 -->
  <svg style="display: none;">
    <defs>
      <symbol id="x-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
        stroke-linejoin="round">
        <path d="m18 6-12 12" />
        <path d="m6 6 12 12" />
      </symbol>
    </defs>
  </svg>

  <div class="container">
    <div class="header">
      <h1>长截图拼接工具</h1>
      <p>智能拼接多张截图，自动识别重叠区域</p>
    </div>

    <div class="upload-section" id="uploadArea">
      <h3>选择图片</h3>
      <div class="upload-prompt" id="uploadPrompt">
        <div class="add-more-btn" id="addMoreBtn">+</div>
      </div>
      <div class="selected-images" id="selectedImages" style="display: none;">
        <div id="fileItems"></div>
      </div>
      <input type="file" id="fileInput" class="file-input" multiple accept="image/*">
    </div>

    <div class="settings">
      <h3>设置</h3>
      <div class="setting-item">
        <label for="ignorePixels">忽略右侧像素数量:</label>
        <input type="number" id="ignorePixels" value="20" min="0" max="100">
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-primary" id="stitchBtn" disabled>
        开始拼接
      </button>
      <button class="btn btn-secondary" id="clearBtn" disabled>
        清空列表
      </button>
    </div>

    <div class="progress" id="progress">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">准备中...</div>
    </div>

    <div class="result" id="result">
      <h3>拼接结果</h3>
      <img id="resultImage" class="result-image" alt="拼接结果" title="点击查看大图">
      <div>
        <button class="btn btn-primary" id="downloadBtn">
          下载图片
        </button>
      </div>
    </div>

    <!-- 图片预览模态框 -->
    <div class="image-modal" id="imageModal">
      <span class="modal-close">&times;</span>
      <img id="modalImage" alt="预览图片">
    </div>
  </div>

  <script src="longshot.js"></script>
  <script>
    class LongShotApp {
      constructor() {
        this.stitcher = new LongScreenshotStitcher();
        this.selectedFiles = [];
        this.resultCanvas = null;
        this.sortable = null; // SortableJS 实例

        this.initializeElements();
        this.bindEvents();
      }

      initializeElements() {
        this.uploadArea = document.getElementById('uploadArea');
        this.fileInput = document.getElementById('fileInput');
        this.uploadPrompt = document.getElementById('uploadPrompt');
        this.selectedImages = document.getElementById('selectedImages');
        this.fileItems = document.getElementById('fileItems');
        this.addMoreBtn = document.getElementById('addMoreBtn');
        this.stitchBtn = document.getElementById('stitchBtn');
        this.clearBtn = document.getElementById('clearBtn');
        this.progress = document.getElementById('progress');
        this.progressFill = document.getElementById('progressFill');
        this.progressText = document.getElementById('progressText');
        this.result = document.getElementById('result');
        this.resultImage = document.getElementById('resultImage');
        this.downloadBtn = document.getElementById('downloadBtn');
        this.ignorePixels = document.getElementById('ignorePixels');
        this.imageModal = document.getElementById('imageModal');
        this.modalImage = document.getElementById('modalImage');
      }

      bindEvents() {
        // 文件选择 - 只通过添加按钮触发
        this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));

        // 添加图片按钮
        this.addMoreBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.fileInput.click();
        });

        // 拖拽上传
        this.uploadArea.addEventListener('dragover', (e) => this.handleDragOver(e));
        this.uploadArea.addEventListener('dragleave', (e) => this.handleDragLeave(e));
        this.uploadArea.addEventListener('drop', (e) => this.handleDrop(e));

        // 按钮事件
        this.stitchBtn.addEventListener('click', () => this.startStitching());
        this.clearBtn.addEventListener('click', () => this.clearFiles());
        this.downloadBtn.addEventListener('click', () => this.downloadResult());

        // 设置变更
        this.ignorePixels.addEventListener('change', () => {
          this.stitcher.setIgnoreRightPixels(parseInt(this.ignorePixels.value) || 20);
        });

        // 图片预览模态框
        this.resultImage.addEventListener('click', () => this.showImageModal());
        this.imageModal.addEventListener('click', () => this.hideImageModal());
        document.querySelector('.modal-close').addEventListener('click', () => this.hideImageModal());
      }

      handleFileSelect(e) {
        const files = Array.from(e.target.files);
        this.addFiles(files);
      }

      handleDragOver(e) {
        e.preventDefault();
        this.uploadArea.classList.add('dragover');
      }

      handleDragLeave(e) {
        e.preventDefault();
        this.uploadArea.classList.remove('dragover');
      }

      handleDrop(e) {
        e.preventDefault();
        this.uploadArea.classList.remove('dragover');

        const files = Array.from(e.dataTransfer.files).filter(file =>
          file.type.startsWith('image/')
        );
        this.addFiles(files);
      }

      addFiles(files) {
        const validFiles = files.filter(file => file.type.startsWith('image/'));
        this.selectedFiles.push(...validFiles);
        this.updateFileList();
        this.updateButtons();
      }

      updateFileList() {
        if (this.selectedFiles.length === 0) {
          // 显示上传提示，隐藏图片区域
          this.uploadPrompt.style.display = 'flex';
          this.selectedImages.style.display = 'none';
          this.destroySortable(); // 销毁拖拽实例
          return;
        }

        // 隐藏上传提示，显示图片区域
        this.uploadPrompt.style.display = 'none';
        this.selectedImages.style.display = 'block';

        this.fileItems.innerHTML = '';
        this.selectedFiles.forEach((file, index) => {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          fileItem.setAttribute('data-file-index', index); // 添加数据属性用于拖拽

          // 创建图片预览
          const fileIconContainer = document.createElement('div');
          fileIconContainer.className = 'file-icon';

          const filePreview = document.createElement('img');
          filePreview.className = 'file-preview';
          filePreview.alt = '图片预览';

          const fileIndex = document.createElement('div');
          fileIndex.className = 'file-index';
          fileIndex.textContent = index + 1;

          fileIconContainer.appendChild(filePreview);
          fileIconContainer.appendChild(fileIndex);

          // 添加删除按钮
          fileItem.innerHTML = `
                        <button class="remove-btn" onclick="app.removeFile(${index})">
                          <svg><use href="#x-icon"></use></svg>
                        </button>
                    `;

          // 将预览图片容器添加到文件项中
          fileItem.appendChild(fileIconContainer);

          // 生成图片预览
          this.generateImagePreview(file, filePreview);

          this.fileItems.appendChild(fileItem);
        });

        // 在图片后面添加"添加更多"按钮
        const addMoreInList = document.createElement('div');
        addMoreInList.className = 'file-item add-more-in-list';
        addMoreInList.innerHTML = '<div class="add-more-icon">+</div>';
        addMoreInList.addEventListener('click', (e) => {
          e.stopPropagation();
          this.fileInput.click();
        });
        this.fileItems.appendChild(addMoreInList);

        // 初始化或重新初始化拖拽排序
        this.initializeSortable();
      }

      generateImagePreview(file, imgElement) {
        const reader = new FileReader();
        reader.onload = function (e) {
          imgElement.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }

      removeFile(index) {
        this.selectedFiles.splice(index, 1);
        this.updateFileList();
        this.updateButtons();
      }

      // 初始化拖拽排序功能
      initializeSortable() {
        this.destroySortable(); // 先销毁之前的实例

        if (this.selectedFiles.length <= 1) return; // 只有一张图片时不需要排序

        this.sortable = new Sortable(this.fileItems, {
          animation: 200, // 动画时长
          ghostClass: 'sortable-ghost', // 拖拽时的占位符样式
          chosenClass: 'sortable-chosen', // 被选中元素的样式
          dragClass: 'sortable-drag', // 拖拽中元素的样式
          filter: '.add-more-in-list', // 排除"添加更多"按钮
          preventOnFilter: false,
          forceFallback: false, // 使用原生 HTML5 拖拽
          fallbackTolerance: 3,
          
          onStart: (evt) => {
            // 拖拽开始时的处理
            console.log('开始拖拽图片', evt.oldIndex);
          },
          
          onEnd: (evt) => {
            // 拖拽结束后更新文件顺序
            if (evt.newIndex !== evt.oldIndex) {
              this.reorderFiles(evt.oldIndex, evt.newIndex);
            }
          }
        });
      }

      // 销毁拖拽排序实例
      destroySortable() {
        if (this.sortable) {
          this.sortable.destroy();
          this.sortable = null;
        }
      }

      // 重新排序文件数组
      reorderFiles(oldIndex, newIndex) {
        if (oldIndex === newIndex) return;

        // 移动文件到新位置
        const movedFile = this.selectedFiles.splice(oldIndex, 1)[0];
        this.selectedFiles.splice(newIndex, 0, movedFile);

        console.log(`图片从位置 ${oldIndex + 1} 移动到位置 ${newIndex + 1}`);

        // 重新渲染列表以更新序号
        this.updateFileList();
      }







      clearFiles() {
        this.selectedFiles = [];
        this.fileInput.value = '';
        this.destroySortable(); // 销毁拖拽实例
        this.updateFileList();
        this.updateButtons();
        this.hideResult();
      }

      updateButtons() {
        const hasEnoughFiles = this.selectedFiles.length >= 2;
        this.stitchBtn.disabled = !hasEnoughFiles;
        this.clearBtn.disabled = this.selectedFiles.length === 0;
      }

      async startStitching() {
        if (this.selectedFiles.length < 2) {
          alert('请至少选择2张图片');
          return;
        }

        this.showProgress();
        this.hideResult();
        this.stitchBtn.disabled = true;

        try {
          this.resultCanvas = await this.stitcher.stitchMultipleImages(
            this.selectedFiles,
            (progress) => this.updateProgress(progress)
          );

          this.showResult();
        } catch (error) {
          console.error('拼接失败:', error);
          alert(`拼接失败: ${error.message}`);
        } finally {
          this.hideProgress();
          this.stitchBtn.disabled = false;
        }
      }

      updateProgress(progress) {
        let percentage, text;

        if (progress.stage === 'loading') {
          percentage = (progress.current / progress.total) * 50;
          text = `加载图片中... (${progress.current}/${progress.total})`;
        } else if (progress.stage === 'stitching') {
          percentage = 50 + (progress.current / progress.total) * 50;
          text = `拼接中... (${progress.current}/${progress.total})`;
        }

        this.progressFill.style.width = `${percentage}%`;
        this.progressText.textContent = text;
      }

      showProgress() {
        this.progress.style.display = 'block';
        this.progressFill.style.width = '0%';
        this.progressText.textContent = '准备中...';
      }

      hideProgress() {
        this.progress.style.display = 'none';
      }

      showResult() {
        if (this.resultCanvas) {
          this.resultImage.src = this.resultCanvas.toDataURL('image/jpeg', 0.9);
          this.result.style.display = 'block';

          // 滚动到结果区域
          this.result.scrollIntoView({ behavior: 'smooth' });
        }
      }

      hideResult() {
        this.result.style.display = 'none';
      }

      downloadResult() {
        if (!this.resultCanvas) return;

        const link = document.createElement('a');
        link.download = `longshot-result-${new Date().getTime()}.jpg`;
        link.href = this.resultCanvas.toDataURL('image/jpeg', 0.9);
        link.click();
      }

      showImageModal() {
        if (this.resultCanvas) {
          this.modalImage.src = this.resultCanvas.toDataURL('image/jpeg', 0.9);
          this.imageModal.style.display = 'block';
          document.body.style.overflow = 'hidden'; // 防止背景滚动
        }
      }

      hideImageModal() {
        this.imageModal.style.display = 'none';
        document.body.style.overflow = 'auto'; // 恢复背景滚动
      }

      formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
      }
    }

    // 初始化应用
    const app = new LongShotApp();

    // 初始化 Lucide 图标
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  </script>
</body>

</html>
```

让我检查一下是否有任何linting错误：

现在让我测试一下功能。先看看现在的页面是什么样的：

完美！我已经成功为图片选择框添加了拖拽排序功能。让我总结一下实现的功能：

## 功能总结

### ✅ 已完成的功能：

1. **引入 SortableJS 库** - 使用轻量级的 SortableJS 库（仅约30KB）来实现拖拽排序
2. **拖拽视觉反馈** - 添加了优雅的视觉效果：
   - 拖拽选中时：轻微放大(1.05倍)、蓝色边框、阴影效果
   - 拖拽占位符：透明度40%、虚线边框
   - 拖拽过程中：5度旋转、深色阴影
   - 拖拽时自动隐藏删除按钮
3. **智能拖拽初始化** - 只有2张以上图片时才启用拖拽功能
4. **实时顺序更新** - 拖拽完成后立即更新 `selectedFiles` 数组顺序
5. **序号自动刷新** - 拖拽后自动重新渲染，更新显示的序号

### 🎯 设计亮点：

- **轻量库选择**：SortableJS 是最轻量且功能强大的拖拽库
- **简洁动效**：200ms 动画时长，流畅不花哨
- **明确反馈**：拖拽时的视觉状态变化非常清晰
- **智能过滤**：排除"添加更多"按钮，只对图片项启用拖拽
- **内存管理**：适当的实例销毁和重新初始化

### 🚀 使用方法：

1. 上传2张以上图片后，图片框会自动启用拖拽排序
2. 点击并拖拽任意图片到新位置即可调整顺序
3. 拖拽过程中有清晰的视觉反馈
4. 松开鼠标后顺序立即生效，序号自动更新

现在你可以访问 `http://localhost:8000` 来测试拖拽排序功能了！图片的顺序会直接影响拼接的结果顺序。

---

**User**

结束

---

**Cursor**

好的，看到你已经对代码进行了一些调整，主要是简化了光标相关的样式和逻辑。这些修改很合理：

1. **简化光标样式** - 移除了复杂的 `grab/grabbing` 光标控制，使用默认光标更简洁
2. **清理拖拽状态管理** - 移除了 body 上的拖拽状态类，减少了不必要的全局状态
3. **精简代码** - 去掉了过于复杂的光标控制逻辑

这样的调整让拖拽功能更加轻量和稳定。现在的实现重点放在了视觉反馈上（缩放、阴影、透明度等），而不是光标变化，这确实更符合"动效要越简单越好，但视觉反馈要非常明确"的要求。

功能已经完成，拖拽排序应该可以正常工作了。如果需要进一步调整或测试，随时告诉我！

